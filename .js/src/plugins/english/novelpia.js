var t=this&&this.__awaiter||function(t,e,n,o){return new(n||(n=Promise))((function(r,i){function a(t){try{c(o.next(t))}catch(t){i(t)}}function s(t){try{c(o.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(a,s)}c((o=o.apply(t,e||[])).next())}))},e=this&&this.__generator||function(t,e){var n,o,r,i={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},a=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return a.next=s(0),a.throw=s(1),a.return=s(2),"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;a&&(a=0,s[0]&&(i=0)),i;)try{if(n=1,o&&(r=2&s[0]?o.return:s[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,s[1])).done)return r;switch(o=0,r&&(s=[2&s[0],r.value]),s[0]){case 0:case 1:r=s;break;case 4:return i.label++,{value:s[1],done:!1};case 5:i.label++,o=s[1],s=[0];continue;case 7:s=i.ops.pop(),i.trys.pop();continue;default:if(!(r=i.trys,(r=r.length>0&&r[r.length-1])||6!==s[0]&&2!==s[0])){i=0;continue}if(3===s[0]&&(!r||s[1]>r[0]&&s[1]<r[3])){i.label=s[1];break}if(6===s[0]&&i.label<r[1]){i.label=r[1],r=s;break}if(r&&i.label<r[2]){i.label=r[2],i.ops.push(s);break}r[2]&&i.ops.pop(),i.trys.pop();continue}s=e.call(t,i)}catch(t){s=[6,t],o=0}finally{n=r=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}};Object.defineProperty(exports,"__esModule",{value:!0});var n=require("@libs/fetch"),o=require("cheerio"),r=require("@libs/defaultCover"),i=require("@libs/novelStatus"),a=function(){function a(){this.id="global.novelpia.com",this.name="Novelpia",this.icon="src/en/novelpia/icon.png",this.site="https://global.novelpia.com",this.version="1.0.0"}return a.prototype.popularNovels=function(r,i){return t(this,arguments,void 0,(function(t,r){var i,a,s,c,l,u=this,p=r.showLatestNovels;return e(this,(function(e){switch(e.label){case 0:return i=[],a="".concat(this.site,"/novels?page=").concat(null!=t?t:1,"&flag_complete=&sort_col=").concat(p?"new_epi_open_dt":"count_view","&flag_cate="),[4,(0,n.fetchApi)(a).then((function(t){return t.text()}))];case 1:return s=e.sent(),c=(0,o.load)(s),(l=c(".nv-list-wrapper")).length&&l.find(".nv-list-item").each((function(t,e){var n=c(e),o=n.find("a").attr("href"),r=n.find("a").text().trim(),a=n.find("img").attr("src");o&&r&&i.push({name:r,path:o.replace(u.site,"").replace(/^\/+|\/+$/g,""),cover:a})})),[2,i]}}))}))},a.prototype.parsePage=function(o,r){return t(this,void 0,void 0,(function(){var t,i,a,s,c;return e(this,(function(e){switch(e.label){case 0:return t=o.split("/")[1],i=(0,n.fetchApi)("https://api-global.novelpia.com/v1/novel/episode/list?novel_no=".concat(t,"&page=").concat(r,"&rows=20&sort=ASC")),a={chapters:[]},s=[],[4,i.then((function(t){return t.json()}))];case 1:return(c=e.sent()).result.list.length>0&&c.result.list.forEach((function(t){s.push({name:t.epi_title,path:t.episode_no.toString(),chapterNumber:t.epi_num})})),a.chapters=s,[2,a]}}))}))},a.prototype.parseNovel=function(a){return t(this,void 0,void 0,(function(){var t,s,c,l,u,p,h,v,f;return e(this,(function(e){switch(e.label){case 0:return t={path:a,name:"Untitled",cover:r.defaultCover,totalPages:-1},[4,(0,n.fetchApi)(this.resolveUrl(a)).then((function(t){return t.text()}))];case 1:return s=e.sent(),c=(0,o.load)(s),t.name=c(".nv-tit").text().trim(),(l=c(".cover-box img").attr("src"))&&(t.cover=l.startsWith("http")?l:"https:"+l),t.author=c(".nv-author .info-author").text().trim(),t.summary=c(".nv-synopsis .synopsis-text").text().trim(),u=c(".nv-tag .tag"),p=[],u.each((function(t,e){var n=c(e).text().trim().replace("#","");n&&p.push(n)})),p.length>0&&(t.genres=p.join(", ")),(h=c("body").text().toLowerCase()).includes("completed")?t.status=i.NovelStatus.Completed:h.includes("ongoing")&&(t.status=i.NovelStatus.Ongoing),v=c("div.header-tit>span").text(),t.totalPages=Math.ceil((null!==(f=parseInt(v))&&void 0!==f?f:1)/20),[2,t]}}))}))},a.prototype.parseChapter=function(r){return t(this,void 0,void 0,(function(){var t,i,a,s,c,l,u,p,h;return e(this,(function(e){switch(e.label){case 0:return[4,(0,n.fetchApi)(this.resolveUrl("viewer/"+r)).then((function(t){return t.text()}))];case 1:t=e.sent(),console.log(t),i=(0,o.load)(t),a=null===(h=i("#__NUXT_DATA__").text().match(/"(ey.*\.ey[^"]*)"/))||void 0===h?void 0:h[1],s="https://api-global.novelpia.com/v1/novel/episode/content?_t=".concat(a),e.label=2;case 2:return e.trys.push([2,4,,5]),[4,(0,n.fetchApi)(s).then((function(t){return t.json()}))];case 3:return c=e.sent(),console.log(c),l=c.result.data,u=Object.values(l),console.log(u),[2,u.join("")];case 4:return p=e.sent(),console.error("Error parsing chapter:",p),[2,""];case 5:return[2]}}))}))},a.prototype.searchNovels=function(o,r){return t(this,void 0,void 0,(function(){var t,i;return e(this,(function(e){switch(e.label){case 0:return t=[],i="https://api-global.novelpia.com/v1/novel/search?page=".concat(null!=r?r:1,"&search_type=all&search_val=").concat(encodeURIComponent(o),"&search_val_input=").concat(encodeURIComponent(o),"&flag_complete=&sort_col=reg_dt&sort=desc&rows=30"),[4,(0,n.fetchApi)(i).then((function(t){return t.json()}))];case 1:return e.sent().result.list.forEach((function(e){t.push({name:e.novel.novel_name,cover:e.novel.novel_img,path:"novel/"+e.novel.novel_no.toString()})})),[2,t]}}))}))},a.prototype.resolveUrl=function(t){return t.startsWith("http")?t:t.startsWith("/")?this.site+t:this.site+"/"+t},a}();exports.default=new a;